{
  "name": "policy-rabbitmq",
  "duration": 10000,
  "saveRawData": "false",
  "inputs": [
    {
      "name": "in",
      "elementType": "RabbitMQInput",
      "configuration": {
        "queue": "logsQueue",
        "host": "localhost",
        "port": 5672,
        "storageLevel": "MEMORY_ONLY",
        "exchangeName": "logsExchange",
        "routingKeys" : [ "webLogsRoute","purchasesRoute"]
      }
    }
  ],
  "dimensions": [
    {
      "dimensionType": "DateTimeBucketer",
      "name": "purchaseDate"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "user"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "totalAmount"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "city"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "postalCode"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "state"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "country"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "customerType"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "paymentType"
    },
    {
      "dimensionType": "DateTimeBucketer",
      "name": "timestamp"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "ipHost"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "userAgent"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "userLog"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "responseCode"
    },
    {
      "dimensionType": "PassthroughBucketer",
      "name": "operatingSystem"
    }
  ],
  "rollups": [
    {
      "dimensionAndBucketTypes": [
        {
          "dimensionName": "purchaseDate",
          "bucketType": "minute"
        }
      ]
    },
    {
      "dimensionAndBucketTypes": [
        {
          "dimensionName": "ipHost",
          "bucketType": "identity"
        },
        {
          "dimensionName": "timestamp",
          "bucketType": "minute"
        }
      ]
    }
  ],
  "outputs": [
    {
      "name": "out-mongo",
      "elementType": "MongoDbOutput",
      "configuration": {
        "clientUri": "mongodb://localhost:27017",
        "timeField": "purchaseDate",
        "timeDimension": "purchaseDate"
      }
    }
  ],
  "operators": [
    {
      "name": "count-operator",
      "elementType": "CountOperator",
      "configuration": {}
    }
  ],
  "parsers": [
    {
      "name": "morphline-parser",
      "elementType": "MorphlinesParser",
      "configuration": {
        "morphline": {
          "id": "morphline1",
          "importCommands": [
            "org.kitesdk.**",
            "com.stratio.ingestion.morphline.**"
          ],
          "commands": [
            {
              "readJson": {}
            },
            {
              "extractJsonPaths": {
                "paths": {
                  "purchaseDate": "/purchaseDate",
                  "user": "/user",
                  "totalAmount": "/totalAmount",
                  "city": "/city",
                  "postalCode": "/postalCode",
                  "state": "/state",
                  "country": "/country",
                  "customerType": "/customerType",
                  "paymentType": "/paymentType",
                  "timestamp": "/timestamp",
                  "ipHost": "/ipHost",
                  "userAgent": "/userAgent",
                  "userLog": "/userLog",
                  "responseCode": "/responseCode",
                  "operatingSystem": "/operatingSystem"
                }
              }
            },
            {
              "removeFields": {
                "blacklist": [
                  "literal:_attachment_body"
                ]
              }
            }
          ]
        }
      }
    },
    {
      "name": "purchaseDate",
      "elementType": "DateTimeParser",
      "configuration": {
        "purchaseDate": "unixMillis"
      }
    },
    {
      "name": "timestamp",
      "elementType": "DateTimeParser",
      "configuration": {
        "timestamp": "unixMillis"
      }
    }
  ]
}
